<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Crowd Mobility Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up-arrow me-2"></i>
                Real-Time Crowd Mobility Analyzer
            </a>
            <div class="text-light">
                <span id="live-indicator" class="badge bg-success">LIVE</span>
                <small id="current-time" class="ms-2">--:--:--</small>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Real-Time Metrics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Crowd Density</h6>
                        <h2 class="card-title" id="crowd-density">--%</h2>
                        <small class="text-muted" id="crowd-status">Loading...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">CO₂ Emissions</h6>
                        <h2 class="card-title" id="co2-emissions">-- kg</h2>
                        <small class="text-muted" id="co2-status">Loading...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Active Vehicles</h6>
                        <h2 class="card-title" id="active-vehicles">--</h2>
                        <small class="text-muted" id="traffic-status">Loading...</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">System Status</h6>
                        <h2 class="card-title" id="system-health">Healthy</h2>
                        <small class="text-muted" id="update-time">Last: --:--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Live Crowd & CO₂ Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="live-chart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Vehicle Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="vehicle-chart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Trends -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">7-Day Daily Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="daily-chart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Alerts</h5>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-3 mt-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">Crowd Mobility Analyzer &copy; 2024</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="mb-0" id="data-stats">Data points: 0 | Last update: --:--</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let charts = {};
        let dataPoints = 0;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadData();
            startAutoRefresh();
            updateTime();
            
            // Update time every second
            setInterval(updateTime, 1000);
        });

        function initCharts() {
            // Live chart
            const liveCtx = document.getElementById('live-chart').getContext('2d');
            charts.live = new Chart(liveCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Crowd Density (%)',
                            data: [],
                            borderColor: '#4361ee',
                            backgroundColor: '#4361ee20',
                            tension: 0.4
                        },
                        {
                            label: 'CO₂ Emissions (kg)',
                            data: [],
                            borderColor: '#f72585',
                            backgroundColor: '#f7258520',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Vehicle chart
            const vehicleCtx = document.getElementById('vehicle-chart').getContext('2d');
            charts.vehicle = new Chart(vehicleCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', '#7209b7']
                    }]
                }
            });

            // Daily chart
            const dailyCtx = document.getElementById('daily-chart').getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Crowd Density (%)',
                        data: [],
                        backgroundColor: '#4361ee80'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function loadData() {
            try {
                // Load metrics
                const metrics = await fetch('/api/realtime-metrics').then(r => r.json());
                updateMetrics(metrics);

                // Load live graph
                const liveData = await fetch('/api/live-graph').then(r => r.json());
                updateLiveChart(liveData);

                // Load daily trends
                const trends = await fetch('/api/daily-trends').then(r => r.json());
                updateDailyChart(trends);

                // Load alerts
                const alerts = await fetch('/api/alerts').then(r => r.json());
                updateAlerts(alerts);

                // Load system status
                const status = await fetch('/api/system-status').then(r => r.json());
                updateSystemStatus(status);

                dataPoints++;
                document.getElementById('data-stats').textContent = 
                    `Data points: ${dataPoints} | Last update: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateMetrics(data) {
            document.getElementById('crowd-density').textContent = 
                data.crowd.density + '%';
            document.getElementById('crowd-status').textContent = 
                data.crowd.status === 'high' ? 'High' : 'Normal';
            document.getElementById('crowd-status').className = 
                data.crowd.status === 'high' ? 'text-danger' : 'text-success';

            document.getElementById('co2-emissions').textContent = 
                data.mobility.total_co2 + ' kg';
            document.getElementById('co2-status').textContent = 
                data.carbon.status === 'high' ? 'High' : 'Normal';

            document.getElementById('active-vehicles').textContent = 
                data.mobility.vehicle_types;
        }

        function updateLiveChart(data) {
            const crowdData = data.crowd_graph || [];
            const co2Data = data.co2_graph || [];
            
            charts.live.data.labels = crowdData.map(d => d.time);
            charts.live.data.datasets[0].data = crowdData.map(d => d.density);
            charts.live.data.datasets[1].data = co2Data.map(d => d.co2);
            charts.live.update();

            // Update vehicle chart
            const vehicleData = data.vehicle_distribution || [];
            charts.vehicle.data.labels = vehicleData.map(d => d.vehicle);
            charts.vehicle.data.datasets[0].data = vehicleData.map(d => d.count);
            charts.vehicle.update();
        }

        function updateDailyChart(data) {
            const crowdTrends = data.crowd_trends || [];
            charts.daily.data.labels = crowdTrends.map(t => t.hour + ':00');
            charts.daily.data.datasets[0].data = crowdTrends.map(t => t.density);
            charts.daily.update();
        }

        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No active alerts</p>';
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                const time = new Date(alert.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const badgeClass = alert.priority === 'high' ? 'danger' : 'warning';
                
                html += `
                    <div class="alert alert-${badgeClass} alert-dismissible fade show mb-2" role="alert">
                        <strong>${getAlertTitle(alert.type)}</strong> at ${alert.location}
                        ${alert.value ? `: ${alert.value}` : ''}
                        <small class="d-block text-muted">${time}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateSystemStatus(status) {
            document.getElementById('system-health').textContent = 
                status.overall_status === 'healthy' ? 'Healthy' : 'Degraded';
            document.getElementById('system-health').className = 
                status.overall_status === 'healthy' ? 'text-success' : 'text-warning';
            
            const minutes = status.database.freshness_minutes || 0;
            document.getElementById('update-time').textContent = 
                `Last: ${minutes} min ago`;
        }

        function updateTime() {
            document.getElementById('current-time').textContent = 
                new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }

        function startAutoRefresh() {
            setInterval(loadData, 5000); // Refresh every 5 seconds
        }

        function getAlertTitle(type) {
            const titles = {
                'high_density': 'High Crowd Density',
                'anomaly': 'Crowd Anomaly',
                'high_co2': 'High CO₂ Level'
            };
            return titles[type] || 'Alert';
        }
    </script>
</body>
</html>